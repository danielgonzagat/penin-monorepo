#!/usr/bin/env bash
set -euo pipefail
exec 9>/var/lock/lemni-outer.lock; flock -n 9 || exit 0
cd /opt/lemniscata
ts=$(date -u +%Y%m%dT%H%M%SZ); art="_artifacts/dgm/$ts"; mkdir -p "$art"

# garante container api vivo e executa runner (gera patch.diff/report.json)
for i in {1..90}; do docker compose ps -q api >/dev/null 2>&1 && break || sleep 1; done
docker compose exec -T api python - <<'PY'
from plugins.DGMPlugin.runner import main; main()
PY

# copia artefatos
docker compose exec -T api bash -lc 'cd plugins/DGMPlugin/out && tar -cf - report.json patch.diff' | tar -xf - -C "$art"
test -s "$art/report.json" || { echo "[outer] sem report.json"; exit 1; }

# gates (rápido) — reutiliza lemni-gater se existir
if command -v /usr/local/bin/lemni-gater >/dev/null 2>&1; then
  /usr/local/bin/lemni-gater "$art/report.json"
fi

# gera contrato eval.json
/usr/local/bin/lemni-eval-batch "$art"

# ledger
ok="$(jq -r '.gates_ok' "$art/eval.json" || echo false)"
echo "$(date -Is) OUTER art=$ts EVAL=$(basename "$art") gates_ok=$ok" >> .ledger
echo "[outer] artifacts at $art"
